# Spring IoC 容器

> In Spring, the objects that form the backbone of your application and that are managed by the Spring IoC container are called beans. A bean is an object that is instantiated, assembled, and managed by a Spring IoC container. Otherwise, a bean is simply one of many objects in your application. Beans, and the dependencies among them, are reflected in the configuration metadata used by a container.
>
> 在Spring中，若干对象互相构成了应用的骨架，这些对象由IoC容器所管理，被称之为bean。Bean均是由Spring IoC容器所实例化、组装并管理的对象，而非单单只是应用中的某个对象。Bean以及它们之间的相互依赖关系则反映在容器所使用的配置元数据之中。

## 1 控制反转

**控制反转**（*Inversion of Control，IoC*）是Spring框架最基础的概念，IoC一般也被称为**依赖注入**（*Dependency Injection，DI*）。

在传统的Java开发中，比如有个类`A`用到了类`B`的对象`b`，一般来说，需要在`A`中显式地实例化`b`。

```java
class A {
    B b;
    A() {
        b = new B(); // 需要显式的new出B的对象。
    }
}

class B {}
```

有了IoC之后，在A只需要定义b，b的对象实例化及将b“注入”到A实例中的步骤，可以交由IoC框架（容器）来做，这个就叫控制反转。

>  It is a process whereby objects define their dependencies (that is, the other objects they work with) only through constructor arguments, arguments to a factory method, or properties that are set on the object instance after it is constructed or returned from a factory method. The container then injects those dependencies when it creates the bean. This process is fundamentally the inverse (hence the name, Inversion of Control) of the bean itself controlling the instantiation or location of its dependencies by using direct construction of classes or a mechanism such as the Service Locator pattern.
>
> （控制反转）是一个过程，在这个过程中的对象，只需要定义它们的依赖项，比如通过构造函数参数、工厂方法参数或是对象自身的setter方法，容器会在创建bean时注入这些依赖。这个过程是**bean自己控制依赖的实例化**或是**服务定位器模式之类的机制控制的依赖的实例化**的**反转**（因而得名，控制反转）。

## 2 Bean

Bean是由Spring IoC容器所实例化、组装并管理的对象。容器加载配置，由配置元数据创建bean。在容器内部，bean的定义是以`BeanDefinition`对象的方式存在，这些对象会包含这些信息：

- 一个包限定（package-qualified）类名：一般来说是定义了bean的实际的实现类。
- Bean的行为配置元素：它阐明了这个bean在容器中的行为（比如作用域、生命周期回调等）。
- 指向当前bean所需要的其他bean的引用：依赖。
- 新创建对象的一些其他配置设置：比如池的大小限制，或是管理连接池的bean中的连接数。



## 2 容器

`org.springframework.beans`包与`org.springframework.context`包是Spring IoC容器的基础，其中的[`BeanFactory`](https://docs.spring.io/spring-framework/docs/5.3.14/javadoc-api/org/springframework/beans/factory/BeanFactory.html)接口是所有IoC容器中最顶层的抽象，其定义了一些如根据名称获取bean、根据类型获取bean、是否包含某bean等容器的基础行为。

![image-20211220174347212](assets/image-20211220174347212.png)

[`ApplicationContext`](https://docs.spring.io/spring-framework/docs/5.3.14/javadoc-api/org/springframework/context/ApplicationContext.html)是`BeanFactory`的子接口，在其基础上增加了一些如AOP的支持、事件的发布和特定应用的上下文等。

我们写的大多数应用都是与`ApplicationContext`打交道，`ApplicationContext`接口几乎代表了Spring IoC容器，它负责了bean的实例化、配置与组装。至于应当实例化哪些bean？bean与bean之间如何依赖、如何装配？容器可以通过读取配置的方式获取。这些配置可以是**XML文件**或是**Java注解**或直接是**Java代码**。

不同形式的配置对应了`ApplicationContext`接口不同的具体实现。

### 2.1 基于XML方式的配置

XML方式的上下文配置，是一种比较传统的，简单且直观的配置方式：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="..." class="...">  
        <!-- collaborators and configuration for this bean go here -->
    </bean>

    <bean id="..." class="...">
        <!-- collaborators and configuration for this bean go here -->
    </bean>

    <!-- more bean definitions go here -->

</beans>
```

XML方式的配置中的bean表现为<beans/>顶层标签内部的多个<bean/>标签。其`id`属性标识了一个独特的bean，是唯一的。其`class`属性定义了bean的类型，其使用的是对应的全限定类名。

这里的`id`属性可以用作被依赖的bean的引用。

### 2.2 基于Java注解方式的配置

