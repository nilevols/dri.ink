# MySQL基础架构

接下来的部分是MySQL的学习笔记，先从宏观上看一看MySQL的基础架构，看一看MySQL有哪些基础的模块，几个模块是如何配合的，以及一条SQL在MySQL中是如何被执行的。MySQL的这部分内容大部分学习自[《MySQL实战45讲》](https://time.geekbang.org/column/intro/139)。

先看看MySQL大致有哪些模块。总体上来说，MySQL可以分为**Server层**与**存储引擎层**。Server层的作用包括处理客户端连接、鉴权、SQL语法分析、生成执行计划（explain）、缓存管理、操作存储引擎等。存储引擎层就是负责数据的存储和查询。MySQL支持多个存储引擎：InnoDB、MyISAM、Memory等，最常用的就是InnoDB。

刚刚讲的Server层中又有多个不同的模块分别负责不同的功能，比如有：

- 连接器：处理客户端的连接，负责权限认证。
- 查询缓存：负责缓存历史查询sql的结果。
- 分析器：执行词法与语法分析。
- 优化器：生成执行计划，并选择使用的索引。
- 执行器：负责操作存储引擎，并返回结果。

![image-20211009223757336](assets/image-20211009223757336.png)

## 1 连接器

对于客户端来说，想要与数据库交互，现要与数据库建立连接。连接器就是负责等待客户端的连接，建立连接，校验用户名密码（认证），校验权限（鉴权），并维护与管理连接。

比如通过终端连接：

```shell
mysql -h127.0.0.1 -P3306 -uroot -p
```

随后在下面的交互中输入密码，然后终端（客户端）与MySQL建立连接，接着连接器就会校验你登陆的用户名与密码。如果校验失败，则会给你一个`"Access denied for user"`错误。用户名密码认证通过后，连接器会从权限表中查出你的权限，并据此限制你后面的数据库操作。不过如果在已经成功连接后，再有人修改你登陆的用户的权限，也不会影响你当前已有的权限（登陆时查出的权限），新的权限会在你重新连接后刷新。

客户端与MySQL建立的连接一般都是长连接，后续的SQL执行都是依赖此连接。不过连接器还会处理长时间不活动的连接，可以通过`show processlist`查看连接的状态与连接的时长。一般如果某个连接空闲超过8小时，连接器会断开该连接，这个8小时可以通过参数`"wait_timeout"`控制。